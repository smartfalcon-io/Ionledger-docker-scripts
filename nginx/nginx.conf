# =========================================================
# 2️⃣ HTTPS (Port 443) - Secure traffic
# =========================================================
server {
    listen 443 ssl;
    server_name bpass.ionledger.co.in endorser.ionledger.co.in;

    # SSL configuration
    ssl_certificate /etc/letsencrypt/live/bpass.ionledger.co.in/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/bpass.ionledger.co.in/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # =========================
    # --- Tenant Proxy ---
    # =========================
    location /tenant-api/ {
        rewrite ^/tenant-api/(.*)$ /$1 break;
        proxy_pass http://tenant-proxy:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =========================
    # --- Tenant UI ---
    # =========================
    location / {
        proxy_pass http://tenant-ui:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin *;
    }

    # =========================
    # --- Traction Agent 1 (Wallet) ---
    # =========================
    location /traction1/ {
        rewrite ^/traction1/(.*)$ /$1 break;
        proxy_pass http://traction-agent:8030;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept, Authorization';
        if ($request_method = OPTIONS) { return 204; }
    }

    # =========================
    # --- Traction Agent 2 (Tenant Proxy Admin) ---
    # =========================
    location /traction-agent1/ {
        rewrite ^/traction-agent1/(.*)$ /$1 break;
        proxy_pass http://traction-agent:8031;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept, Authorization';
        if ($request_method = OPTIONS) { return 204; }
    }

    # =========================
    # --- Ionledger Web UI ---
    # =========================
    location /ionledger-web-ui/ {
        proxy_pass http://ion-ledger-web-ui:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # =========================
    # --- Issuer APIs ---
    # =========================
    location /issuer/ {
        rewrite ^/issuer/(.*)$ /$1 break;
        proxy_pass http://issuer-apis:8087;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept, Authorization';
        if ($request_method = OPTIONS) { return 204; }
    }

    # =========================
    # --- Keycloak Admin ---
    # =========================
    location /admin/ {
        rewrite ^/admin(/.*)$ $1 break;
        proxy_pass http://keycloak:8080;
        proxy_redirect off;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =========================
    # --- Endorser APIs / Agents ---
    # =========================
    location /endorser-api/ {
        rewrite ^/endorser-api/(.*)$ /$1 break;
        proxy_pass http://endorser-api:5000;
    }

    location /endorser-api-1/ {
        rewrite ^/endorser-api-1/(.*)$ /$1 break;
        proxy_pass http://endorser-api-1:5001;
    }

    location /endorser-agent-1/ {
        rewrite ^/endorser-agent-1/(.*)$ /$1 break;
        proxy_pass http://endorser-agent-1:9033;
    }

    location /endorser-agent-2/ {
        rewrite ^/endorser-agent-2/(.*)$ /$1 break;
        proxy_pass http://endorser-agent:9030;
    }

    location /endorser-agent-3/ {
        rewrite ^/endorser-agent-3/(.*)$ /$1 break;
        proxy_pass http://endorser-agent-1:9032;
    }

    location /endorser-agent-4/ {
        rewrite ^/endorser-agent-4/(.*)$ /$1 break;
        proxy_pass http://endorser-agent:9031;
    }
}
