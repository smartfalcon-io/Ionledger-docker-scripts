# # /Ionledger-docker-scripts/nginx/nginx.config
# server {
#     listen 80;
#     server_name ionledger.duckdns.org;
#     return 301 https://$host$request_uri;
# }

# # HTTPS server
# server {
#     listen 443 ssl;
#     server_name ionledger.duckdns.org;

#     ssl_certificate /etc/letsencrypt/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/privkey.pem;

#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;

#     # ------------------------------
#     # IonLedger Web UI
#     # ------------------------------
#     location /ionledger-web-ui/ {
#         proxy_pass http://ion-ledger-web-ui:80/;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_http_version 1.1;
#         proxy_set_header Connection "";
#     }

#     # ------------------------------
#     # Tenant UI
#     # ------------------------------
#     location /tenant-ui/ {
#         # rewrite ^/assets/(.*)$ /tenant-ui/assets/$1 break;
#         proxy_pass http://tenant-ui:8080/;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_http_version 1.1;
#         proxy_set_header Connection "";

#         proxy_redirect off;
#     }

#     # ------------------------------
#     # Battery Passport FastAPI backend
#     # ------------------------------
#     location /fastapi/ {
#         proxy_pass http://issuer-apis:8087/;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         sub_filter_once off;
#         sub_filter '"/openapi.json"' '"/fastapi/openapi.json"';
#         sub_filter 'href="/docs"' 'href="/fastapi/docs"';
#         proxy_http_version 1.1;
#         proxy_set_header Connection "";
#     }

#     # ------------------------------
#     # Traction Agent (ACA-Py)
#     # ------------------------------
#     # location /traction-agent/ {
#     #     proxy_pass http://tenant-proxy:8030/;
#     #     proxy_set_header Host $host;
#     #     proxy_set_header X-Real-IP $remote_addr;
#     #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     #     proxy_set_header X-Forwarded-Proto $scheme;
#     #     proxy_http_version 1.1;
#     #     proxy_set_header Connection "";
#     # }

#     # ------------------------------
#     # Optional: Redirect root to Web UI
#     # ------------------------------
#     location = / {
#         return 301 /ionledger-web-ui/;
#     }

#     # ------------------------------
#     # Logging
#     # ------------------------------
#     access_log /var/log/nginx/access.log;
#     error_log /var/log/nginx/error.log;
# }






# /Ionledger-docker-scripts/nginx/nginx.config 

# HTTP Server Block (for Certbot challenge and HTTPS redirection)
server {
    listen 80;
    server_name bpass-ionledger.duckdns.org;

    # Certbot verification path
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        allow all;
    }

    # Redirect all other HTTP traffic to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
}

# HTTPS Server Block
server {
    listen 443 ssl;
    server_name bpass-ionledger.duckdns.org;

    # SSL configuration
    ssl_certificate /etc/letsencrypt/live/ionledger.duckdns.org-0001/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ionledger.duckdns.org-0001/privkey.pem;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    # (Optional: Add stronger ciphers here)

    # ------------------------------
    # IonLedger Web UI
    # ------------------------------
    location /ionledger-web-ui/ {
        proxy_pass http://ion-ledger-web-ui:80/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https; # <--- IMPORTANT: Set scheme to https
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # ------------------------------
    # Tenant UI
    # ------------------------------
    location /tenant-ui/ {
        # rewrite ^/assets/(.*)$ /tenant-ui/assets/$1 break;
        proxy_pass http://tenant-ui:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https; 
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_redirect off;

        sub_filter 'href="/' 'href="/tenant-ui/';
        sub_filter 'src="/' 'src="/tenant-ui/';
        sub_filter '"/config"' '"/tenant-ui/config"';

        sub_filter_once off;
    }


    

    # ------------------------------
    # Battery Passport FastAPI backend
    # ------------------------------
    location /fastapi/ {
        proxy_pass http://issuer-apis:8087/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https; # <--- IMPORTANT: Set scheme to https
        sub_filter_once off;
        sub_filter '"/openapi.json"' '"/fastapi/openapi.json"';
        sub_filter 'href="/docs"' 'href="/fastapi/docs"';
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # ------------------------------
    # Optional: Redirect root to Web UI
    # ------------------------------
    location = / {
        return 301 /ionledger-web-ui/;
    }

    # ------------------------------
    # Logging
    # ------------------------------
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
}

